
# **Topic 4.2 — Tool Calling with Strict Structured Output & Zero Hallucination**

---

## **Problem 1: Wrong Info (Model Hallucination)**

Gemini (and any LLM) often **mixes real data + assumptions** when it rephrases results.
In your case:

* The tool fetched the real API (followers = 1)
* But Gemini, while generating a “summary”, **added creative guesses (followers = 7)**

This happens because Gemini merges factual data with its own language-generation process.

---

## **Goal**

We’ll **strictly control output** so Gemini:

* **Only prints tool output**
* **Doesn’t modify or imagine numbers**
* **Returns clean JSON (structured)**

---

## **Concept: Structured Tool Output + `responseMimeType`**

We’ll combine:

* Tool calling
* Structured output enforcement (`responseMimeType: "application/json"`)
* Zod schema to define structure

This forces Gemini to respond with **pure structured JSON**, no extra text or summaries.

---

## **File: `src/08.github-structured-tool.js`**

```js
// -------------------------------------------------------------
// GOAL: Combine Tool Calling + Structured Output
// -------------------------------------------------------------
// Concepts:
// - Fetch live GitHub data via tool
// - Enforce structured JSON response (no hallucination)
// - Validate schema using Zod
// -------------------------------------------------------------

import ai from "../utils/geminiClient.js";
import fetch from "node-fetch";
import { z } from "zod";
import { zodToJsonSchema } from "zod-to-json-schema";

// 1️⃣ Define the GitHub API Tool
async function getGithubProfile({ username }) {
  const url = `https://api.github.com/users/${username}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`GitHub user ${username} not found.`);
  const data = await res.json();

  // Return only factual data, no interpretation
  return {
    username: data.login,
    name: data.name,
    bio: data.bio,
    followers: data.followers,
    following: data.following,
    public_repos: data.public_repos,
    location: data.location,
    html_url: data.html_url,
    created_at: data.created_at,
  };
}

// 2️⃣ Define schema to enforce structured output
const profileSchema = z.object({
  username: z.string(),
  name: z.string().nullable(),
  bio: z.string().nullable(),
  followers: z.number(),
  following: z.number(),
  public_repos: z.number(),
  location: z.string().nullable(),
  html_url: z.string(),
  created_at: z.string(),
});

// 3️⃣ Define tool metadata
const tools = [
  {
    name: "getGithubProfile",
    description: "Fetches public GitHub profile info.",
    parameters: {
      type: "object",
      properties: {
        username: { type: "string", description: "GitHub username" },
      },
      required: ["username"],
    },
    function: getGithubProfile,
  },
];

// 4️⃣ Prompt Gemini with JSON response enforcement
const prompt = `
Get the GitHub profile for user "tanishkumardev".
Return only verified fields from the API in structured JSON format.
Do not summarize or assume anything not in the fetched data.
`;

// 5️⃣ Execute and enforce structured response
async function main() {
  console.log("Starting GitHub Structured Tool Example...\n");

  const response = await ai.models.generateContent({
    model: "gemini-2.5-flash",
    contents: prompt,
    tools: tools,
    config: {
      responseMimeType: "application/json",
      responseJsonSchema: zodToJsonSchema(profileSchema),
    },
  });

  // 6️⃣ Validate JSON structure
  const parsed = profileSchema.parse(JSON.parse(response.text));

  console.log("Structured GitHub Data (Verified):\n");
  console.log(parsed);
}

await main();
```

---

## **Expected Output**

```
Starting GitHub Structured Tool Example...

Structured GitHub Data (Verified):

{
  username: "tanishkumardev",
  name: "Tanish Kumar",
  bio: "I am a full-stack developer with a passion for building scalable and user-friendly web applications...",
  followers: 1,
  following: 0,
  public_repos: 41,
  location: "India",
  html_url: "https://github.com/tanishkumardev",
  created_at: "2022-10-12T06:18:11Z"
}
```

---

## **How This Fixes Your Issues**

| Problem                    | Fix                                                             |
| -------------------------- | --------------------------------------------------------------- |
| Gemini added wrong numbers | Tool returns factual API JSON only                              |
| Model generated paragraphs | `responseMimeType: "application/json"` forces structured format |
| No readability             | JSON schema validation ensures consistent keys                  |
| Risk of hallucination      | `Do not summarize` instruction in prompt + enforced schema      |

---

## **Validation Flow**

```
Gemini → decides to call Tool
Tool → fetches real data
Gemini → must respond with JSON (not text)
SDK → validates against schema
Developer → gets clean JSON object
```

---

## **Optional Enhancement: Auto Format JSON Output**

If you want pretty-printed JSON in console:

```js
console.log(JSON.stringify(parsed, null, 2));
```

---

## **Notes for `/Topics OR Concepts/topic4/`**

**File:**
`03.github-structured-tool.md`

```
# Topic 4.2: GitHub Tool with Structured Output

Goal:
- Fix data hallucination issues.
- Enforce factual, structured JSON output.

Technique:
- Combine Tool Calling + responseMimeType + Zod Schema
- Gemini must output JSON strictly matching the schema

Advantages:
- Reliable for production workflows
- No creative deviations
- Easy to integrate into databases or APIs
```

---

## **Practice Tasks**

1. Try running:

   ```
   "Get the GitHub profile for user 'torvalds'"
   ```

   and confirm follower count matches GitHub.

2. Extend schema with a new field like:

   ```js
   company: z.string().nullable()
   ```

   and re-run.

3. Print both **raw** response (`response.text`) and **validated** output to observe the difference.

---